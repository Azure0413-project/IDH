{% extends 'base.html' %} {% block content %} {% load static %}
<div class="container">
  <div class="tab">
    <button class="tablinks active">
      <img src="{%static 'img/record.svg'%}" />透<br/>析<br/>紀<br/>錄<br/>
    </button>
  </div>
<div id="dashboard" class="tabcontent">
  <form method="post" action="get_detail_idh" enctype="multipart/form-data">
  {% csrf_token %} 
  <div class="map">
    <section class="area">
      <h1>B</h1>
      <ul class="up">
      {% for patient in b_patients %}
        {% if patient.id == '---' %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-inactive" type="button">
            <div class="bed-feedback-text">{{ patient.bed }} 無紀錄</div>
          </button>
        {% else %}
          {% if patient.status %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-active" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
            <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
            <input type="hidden" value="{{ patient.bed }}" name="idh-patient">
          </button>
          {% else %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
            <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
          </button>
          {% endif %}
        {% endif %}
      {% endfor %}
      </ul>
      <div class="divider"></div>
    </section>
    <section class="area">
      <h1>C</h1>
      <ul class="up">
      {% for patient in c_patients %}
        {% if patient.id == '---' %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-inactive" type="button">
            <div class="bed-feedback-text">{{ patient.bed }} 無紀錄</div>
          </button>
        {% else %}
          {% if patient.status %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-active" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
            <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
            <input type="hidden" value="{{ patient.bed }}" name="idh-patient">
          </button>
          {% else %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
            <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
          </button>
          {% endif %}
        {% endif %}
      {% endfor %}
      </ul>
      <div class="divider"></div>
    </section>
    <section class="area">
      <h1>D</h1>
      <ul class="up">
      {% for patient in d_patients %}
        {% if patient.id == '---' %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-inactive" type="button">
            <div class="bed-feedback-text">{{ patient.bed }} 無紀錄</div>
          </button>
        {% else %}
          {% if patient.status %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-active" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
            <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
            <input type="hidden" value="{{ patient.bed }}" name="idh-patient">
          </button>
          {% else %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
            <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
          </button>
          {% endif %}
        {% endif %}
      {% endfor %}
      </ul>
    </section>
    <section class="area">
      <h1>A</h1>
      <ul class="down">
      {% for patient in a_patients %}
        {% if patient.bed == '' %}
        <li></li>
        {% else %}
          {% if patient.id == '---' %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-inactive" type="button">
            <div class="bed-feedback-text">{{ patient.bed }} 無紀錄</div>
          </button>
          {% else %}
            {% if patient.status %}
            <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-active" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
              <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
              <input type="hidden" value="{{ patient.bed }}" name="idh-patient">
            </button>
            {% else %}
            <button id="feedback-{{ patient.bed }}" class="bed-feedback" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
              <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
            </button>
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}
      </ul>
      <div class="divider"></div>
    </section>
    <section class="area">
      <h1>E</h1>
      <ul class="down">
        {% for patient in e_patients %}
        {% if patient.bed == '' %}
        <li></li>
        {% else %}
          {% if patient.id == '---' %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-inactive" type="button">
            <div class="bed-feedback-text">{{ patient.bed }} 無紀錄</div>
          </button>
          {% else %}
            {% if patient.status %}
            <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-active" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
              <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
              <input type="hidden" value="{{ patient.bed }}" name="idh-patient">
            </button>
            {% else %}
            <button id="feedback-{{ patient.bed }}" class="bed-feedback" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
              <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
            </button>
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}
      </ul>
      <div class="divider"></div>
    </section>
    <section class="area">
      <h1>I</h1>
      <ul class="down">
      {% for patient in i_patients %}
        {% if patient.bed == '' %}
        <li></li>
        {% else %}
          {% if patient.id == '---' %}
          <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-inactive" type="button">
            <div class="bed-feedback-text">{{ patient.bed }} 無紀錄</div>
          </button>
          {% else %}
            {% if patient.status %}
            <button id="feedback-{{ patient.bed }}" class="bed-feedback bed-feedback-active" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
              <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
              <input type="hidden" value="{{ patient.bed }}" name="idh-patient">
            </button>
            {% else %}
            <button id="feedback-{{ patient.bed }}" class="bed-feedback" type="button" onclick="changeStatus('feedback-{{ patient.bed }}');">
              <div class="bed-feedback-text">{{ patient.bed }}  {{ patient.id.p_name }}</div>
            </button>
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}
        <li></li>
        <li></li>
        <li></li>
        <button id="confirmPatientBtn" class="btn-confirm" type="submit">確 認</button>
      </ul>
    </section>
    <script>
      function changeStatus(bed_id) {
        let bed = document.getElementById(bed_id);
        if(bed.classList.contains("bed-feedback-active")){
          bed.children[1].remove();
        } else {
          let inputEle = document.createElement("input");
          inputEle.type = "hidden";
          inputEle.value = bed.id.split('-')[1];
          inputEle.name = "idh-patient";
          bed.appendChild(inputEle);
        }
        bed.classList.toggle("bed-feedback-active");
      }
      function writeDetail() {
        let modal = document.getElementById("modal");
        modal.classList.toggle("hidden");
        let idh_patients = document.getElementsByClassName("bed-feedback-active");
        console.log(idh_patients);
        let idh_id = [];
        for(let i = 0; i < idh_patients.length; i++) {
          let tmp = idh_patients[i].id.split('-')[1];
          idh_id.push(tmp);
        }
        console.log(idh_id);
      }
    </script>
  </div>
  </form>
</div>
{% if home %}
<div id="modal" class="modal hidden">
{% else %}
<div id="modal" class="modal">
  <!-- Modal content -->
  <div class="modal-idh">
    <div class="modal-feedback">
      <form method="post" action="">
        {% for patient in patients %}
        <div class="feedback-patient">
          <div class="feedback-left">
            <div class="feedback-name">{{ patient.setting.bed }}  {{ patient.id.p_name }}</div>
            <div class="idh-linechart" id="{{ patient.chart_id }}"></div>
            <script>
              chart = {{ patient.chart|safe }};
              xAxis = chart.map(data => data["timestamp"])
              SBP = chart.map(data => data["SBP"]);
              pulse = chart.map(data => data["pulse"]);
              CVP = chart.map(data => data["CVP"]);
              exist = false;
              linechart = Highcharts.chart("{{ patient.chart_id|safe }}", {
                chart: { 
                  type: "line",
                  height: 260 + "em",
                  width: 1000,
                  backgroundColor: "#f4f7fb",
                  spacing: [30, 0, 0, 10],
                  events: {
                    click: function(e) {
                      let index = Math.round(e.xAxis[0].value);
                      exist = false;
                      let nowbands = this.xAxis[0].plotLinesAndBands;
                      for(let i = 0; i < nowbands.length; i++) {
                        if(nowbands[i].id == "{{ patient.id.p_id |safe }}" + "-band-" + index) {
                          exist = true;
                          IDH = IDH.filter(function(item) {
                              return item['index'] != index;
                          });
                          removePlotBand(index, {{ patient.id.p_id|safe }});
                          break;
                        }
                      }
                      if(!exist) {
                        IDH.push({
                          "index": index,
                          "patient_id": {{ patient.id.p_id|safe }},
                          "timestamp": chart[index].timestamp,
                          "SBP": chart[index].SBP,
                        })
                        addPlotBand(index, {{ patient.id.p_id|safe }});
                      }
                    },
                  }
                },
                title: { 
                  style: {
                    "display": "none",
                  }
                },
                credits: {
                  enabled: false,
                },
                legend: {
                  align: "right",
                  verticalAlign: "middle",
                  layout: "vertical",
                  itemMarginTop: 10,
                  itemStyle: {
                    color: "#4A5563",
                    fontSize: "18px",
                  },
                  symbolWidth: 24,
                  symbolHeight: 24,
                  symbolPadding: 10,
                },
                tooltip: {
                  borderRadius: 8,
                },
                xAxis: { 
                  categories: xAxis,
                },
                yAxis: [
                {
                  title: { 
                    text: "壓力",
                    rotation: 0,
                    align: "high",
                    style: {
                      fontSize: "18px",
                      color: "#4A5563",
                    },
                    y: -15,
                    offset: 25,
                  },
                  labels: { 
                    algin: "center",
                    format: "{value} mmHg",
                    style: {
                      fontSize: 12,
                    }
                  },
                  minorTicks: true,
                },
                {
                  opposite: true,
                  title: { 
                    text: "脈搏",
                    rotation: 0,
                    align: "high",
                    style: {
                      fontSize: "18px",
                      color: "#4A5563",
                    },
                    y: -15,
                    offset: 15,
                  },
                  labels: { 
                    algin: "center",
                    format: "{value} bpm",
                    style: {
                      fontSize: 12,
                    }
                  },
                }],
                series: [
                {
                  name: "收縮壓",
                  data: SBP,
                  lineWidth: 3,
                  color: "#fe7878",
                },
                {
                  name: "脈搏",
                  data: pulse,
                  yAxis: 1,
                  lineWidth: 3,
                },
                {
                  name: "靜脈壓",
                  data: CVP,
                  lineWidth: 3,
                  color: "#999999"
                }],
              });
              for(let i = 0; i < chart.length; i++) {
                if(chart[i].SBP > 0 && chart[i].SBP <= 90) {
                  IDH.push({
                    "index": i,
                    "patient_id": {{ patient.id.p_id |safe }},
                    "timestamp": chart[i].timestamp,
                    "SBP": chart[i].SBP,
                  })
                  linechart.xAxis[0].addPlotBand({
                    from: i - 0.5,
                    to: i + 0.5,
                    color: "#ffecc4",
                    borderColor: "#CBD3DE",
                    borderWidth: 0.5,
                    id: "{{ patient.id.p_id |safe }}" + "-band-" + i,
                  })
                }
              }
              linecharts.push({
                "p_id": {{ patient.id.p_id }},
                "linechart": linechart,
              });
              function removePlotBand(index, p_id) {
                let id = p_id + "-band-" + index;
                for(let i = 0; i < linecharts.length; i++){
                  if(linecharts[i].p_id == p_id){
                    linecharts[i].linechart.xAxis[0].removePlotBand(id);
                  }
                }
              }
              function addPlotBand(index, p_id){
                for(let i = 0; i < linecharts.length; i++){
                  if(linecharts[i].p_id == p_id){
                    linecharts[i].linechart.xAxis[0].addPlotBand({
                      from: index - 0.5,
                      to: index + 0.5,
                      color: "#ffecc4",
                      borderColor: "#CBD3DE",
                      borderWidth: 0.5,
                      id: p_id + "-band-" + index,
                    });
                  }
                }
              }
            </script>
          </div>
          <div class="feedback-right">
            <div class="note">
              <div class="note-title">症狀</div>
              <label class="note-container">是
                <input type="radio" name="symptom-{{ patient.id.p_id }}">
                <span class="checkmark radio"></span>
              </label>
              <label class="note-container">否
                <input type="radio" name="symptom-{{ patient.id.p_id }}">
                <span class="checkmark radio"></span>
              </label>
            </div>
            <div class="note">
              <div class="note-title">處理</div>
              <label class="note-container">口服藥物
                <input type="checkbox" name="treatment-{{ patient.id.p_id }}">
                <span class="checkmark checkbox"></span>
              </label>
              <label class="note-container">針劑藥物
                <input type="checkbox" name="treatment-{{ patient.id.p_id }}">
                <span class="checkmark checkbox"></span>
              </label>
              <label class="note-container">調整透析設定
                <input type="checkbox" name="treatment-{{ patient.id.p_id }}">
                <span class="checkmark checkbox"></span>
              </label>
              <label class="note-container">其他
                <input type="checkbox" name="treatment-{{ patient.id.p_id }}">
                <span class="checkmark checkbox"></span>
              </label>
            </div>
          </div>
        </div>
        {% if forloop.last %}
        {% else %}
        <hr class="rounded">
        {% endif %}
        {% endfor %}
        <button id="confirmFeedbackBtn" class="btn-confirm feedback-btn" type="submit">確 認</button>
        <div class="close-btn" onclick="closeModal()">
          <img src="{%static 'img/close.svg'%}" />
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}